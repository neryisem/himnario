<!DOCTYPE html>
<html lang="es">
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Mi Playlist de PDFs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      :root { --bg: #f8f9fa; --text: #212529; --sidebar: #ffffff; --item-border: #eee; --modal-bg: #fff; }
      [data-theme="dark"] { --bg: #121212; --text: #e0e0e0; --sidebar: #1e1e1e; --item-border: #333; --modal-bg: #222; }
      
      body { background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; font-family: 'Segoe UI', sans-serif; transition: 0.3s; }
      .header-playlist { background: #212529; color: white; height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 2px solid #333; z-index: 1001; }
      .btn-nav { height: 50px; width: 55px; font-size: 20px; font-weight: bold; border-radius: 12px; }
      .main-app { display: flex; height: calc(100vh - 70px); position: relative; }
      
      .sidebar { width: 320px; background: var(--sidebar); border-right: 1px solid var(--item-border); display: flex; flex-direction: column; transition: transform 0.4s ease, width 0.4s ease; }
      .sidebar.hidden { width: 0; transform: translateX(-100%); overflow: hidden; }
      .lista-docs { flex: 1; overflow-y: auto; }
      
      .btn-pdf { width: 100%; text-align: left; padding: 15px; border: none; background: transparent; border-bottom: 1px solid var(--item-border); color: var(--text); font-size: 15px; display: flex; justify-content: space-between; align-items: center; }
      .paginacion { display: flex; gap: 5px; padding: 10px; flex-wrap: wrap; background: #212529; }
      .btn-pag { padding: 4px 8px; font-size: 11px; border-radius: 5px; border: 1px solid #555; background: #333; color: white; cursor: pointer; }
      .btn-pag.active { background: #0d6efd; border-color: #0d6efd; }
      
      .viewer-container { flex: 1; background: #525659; position: relative; }
      .visor-frame { width: 100%; height: 100%; border: none; }
      
      /* Toast de 2 segundos */
      #toast { visibility: hidden; min-width: 250px; background: #333; color: #fff; text-align: center; border-radius: 25px; padding: 12px; position: fixed; z-index: 4000; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
      #toast.show { visibility: visible; opacity: 1; }
      
      .modal-custom { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
      .modal-content { background: var(--modal-bg); color: var(--text); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
      
      .star { color: #ccc; font-size: 20px; cursor: pointer; padding-right: 10px; }
      .star.active { color: #ffc107; }
      
      @media (max-width: 768px) { 
        .sidebar { width: 100%; position: absolute; z-index: 1000; height: 100%; } 
        body.modo-visor .sidebar { transform: translateX(-100%); } 
      }
    </style>
  </head>
  <body data-theme="light">
    
    <div id="confirmModal" class="modal-custom">
      <div class="modal-content">
        <h5 class="mb-3">Confirmar Descarga</h5>
        <p>¬øEst√° seguro que desea descargar todo el himnario edici√≥n 2025?</p>
        <div class="d-flex justify-content-center gap-3 mt-4">
          <button class="btn btn-secondary px-4" onclick="cerrarModal()">NO</button>
          <button class="btn btn-success px-4" onclick="confirmarDescarga()">S√ç</button>
        </div>
      </div>
    </div>

    <div id="toast">Notificaci√≥n</div>
    
    <div class="header-playlist">
      <div class="d-flex gap-2">
        <button class="btn btn-outline-light btn-sm" onclick="irALista()" title="Lista">üìÇ</button>
        <button class="btn btn-outline-info btn-sm" onclick="toggleSidebar()" title="Expandir">‚ÜîÔ∏è</button>
        <button class="btn btn-outline-warning btn-sm" onclick="toggleTheme()" title="Modo Oscuro">üåì</button>
        <button class="btn btn-success btn-sm fw-bold" onclick="abrirModal()" title="Descargar Todo">üì•</button>
      </div>
      <div class="d-flex align-items-center">
        <button class="btn btn-primary btn-nav" onclick="paso(-1)">‚óÄ</button>
        <div id="contador" class="mx-3 fw-bold text-warning">0/0</div>
        <button class="btn btn-primary btn-nav" onclick="paso(1)">‚ñ∂</button>
      </div>
      <button class="btn btn-danger btn-sm" onclick="limpiar()">Limpiar</button>
    </div>

    <div class="main-app">
      <div class="sidebar" id="sidebar">
        <div class="p-3 bg-dark">
          <input type="text" id="buscador" class="form-control mb-2" placeholder="üîç Buscar..." onkeyup="filtrar()">
          <div id="paginas" class="paginacion"></div>
        </div>
        <div id="lista" class="lista-docs">
          <div class="p-4 text-center text-muted" id="status">Cargando coros...</div>
        </div>
      </div>
      <div class="viewer-container">
        <iframe id="visorMain" class="visor-frame" src=""></iframe>
      </div>
    </div>

    <script>
      const LINK_DROPBOX = "https://www.dropbox.com/scl/fo/q1t3ra4k9xtfittocpizo/AANhxulckk_NYDFKuZfB23g?rlkey=b0fztpkmiaposrq7cn0ppnbfn&st=cjqj9dhn&dl=1";

      let db = [], playlist = [], favoritos = JSON.parse(localStorage.getItem('favs_pdfs')) || [], pos = -1, paginaActual = 0;
      const tPagina = 50;
      
      window.onload = () => {
        const cached = localStorage.getItem('db_offline');
        if (cached) { 
          db = JSON.parse(cached); 
          render(); 
        }

        fetch('datos.json')
          .then(response => response.json())
          .then(res => {
            db = res;
            localStorage.setItem('db_offline', JSON.stringify(res));
            if(document.getElementById('status')) document.getElementById('status').style.display='none';
            render();
          })
          .catch(err => {
            console.log("Usando datos de cach√©.");
            if(db.length > 0 && document.getElementById('status')) document.getElementById('status').style.display='none';
          });
      };

      function render() { crearPaginacion(); cargarPagina(paginaActual); }

      function mostrarToast(msg) { 
        const t = document.getElementById("toast"); 
        t.innerText = msg; 
        t.classList.add("show"); 
        setTimeout(() => t.classList.remove("show"), 2000); 
      }
      
      function abrirModal() { document.getElementById('confirmModal').style.display = 'flex'; }
      function cerrarModal() { document.getElementById('confirmModal').style.display = 'none'; }
      function confirmarDescarga() {
        cerrarModal();
        mostrarToast("Iniciando descarga masiva...");
        window.open(LINK_DROPBOX, '_blank');
      }

      function toggleTheme() {
        const body = document.body;
        const current = body.getAttribute('data-theme');
        const next = current === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', next);
        mostrarToast("Modo " + (next === 'light' ? 'Claro' : 'Oscuro'));
      }

      function crearPaginacion() {
        const n = Math.ceil(db.length / tPagina);
        let h = "";
        for(let i=0; i<n; i++) h += `<div class="btn-pag ${i===paginaActual?'active':''}" onclick="cargarPagina(${i})">D${i+1}</div>`;
        document.getElementById('paginas').innerHTML = h;
      }

      function cargarPagina(p) {
        paginaActual = p;
        dibujar(db.slice(p * tPagina, (p + 1) * tPagina));
        crearPaginacion();
      }

      function dibujar(datos) {
        let h = "";
        datos.forEach(item => {
          const isFav = favoritos.includes(item.id) ? 'active' : '';
          h += `<div class="btn-pdf">
            <span class="star ${isFav}" onclick="toggleFav('${item.id}')">‚òÖ</span>
            <span onclick="add('${item.id}')" style="flex:1; cursor:pointer;">${item.nombre}</span>
            <div class="d-flex gap-1">
              <button class="btn btn-sm btn-success" onclick="descargarInd('${item.id}')">‚¨á</button>
              <button class="btn btn-sm btn-outline-primary" onclick="add('${item.id}')">+</button>
            </div>
          </div>`;
        });
        document.getElementById('lista').innerHTML = h || '<p class="p-3 text-center">Sin resultados</p>';
      }

      function add(id) {
        const itemOriginal = db.find(i => i.id === id);
        if (!itemOriginal) return;

        // Validar si ya existe el PDF exacto en la lista
        if (playlist.some(i => i.id === id)) {
          mostrarToast("El PDF ya ha sido a√±adido anteriormente.");
          return;
        }

        playlist.push(itemOriginal);
        mostrarToast("A√±adido: " + itemOriginal.nombre);
        
        if (playlist.length === 1) { 
          pos = 0; 
          cargarVisor(); 
        }
        actualizarUI();
      }

      function cargarVisor() {
        if (pos >= 0 && pos < playlist.length) {
          // Este enlace es mucho m√°s r√°pido que el de /preview
          // Fuerza al navegador a usar su propio lector de PDF
          const url = "https://docs.google.com/viewerng/viewer?embedded=true&url=https://drive.google.com/uc?id=" + playlist[pos].id;
          
          document.getElementById('visorMain').src = url;
          
          if (window.innerWidth <= 768) document.body.classList.add('modo-visor');
        }
        actualizarUI();
      }

      function paso(n) { 
        if (pos + n >= 0 && pos + n < playlist.length) { 
          pos += n; 
          cargarVisor(); 
        } 
      }

      function actualizarUI() { 
        document.getElementById('contador').innerText = playlist.length > 0 ? (pos + 1) + "/" + playlist.length : "0/0"; 
      }

      function limpiar() { 
        playlist = []; 
        pos = -1; 
        document.getElementById('visorMain').src = ""; 
        actualizarUI(); 
        irALista(); 
        mostrarToast("Lista vaciada."); 
      }

      function irALista() { document.body.classList.remove('modo-visor'); }
      
      function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
      
      function filtrar() {
        const q = document.getElementById('buscador').value.toLowerCase();
        if (!q) return cargarPagina(paginaActual);
        const filtrados = db.filter(a => a.nombre.toLowerCase().includes(q));
        dibujar(filtrados.slice(0, 100));
      }

      function toggleFav(id) {
        favoritos = favoritos.includes(id) ? favoritos.filter(f => f !== id) : [...favoritos, id];
        localStorage.setItem('favs_pdfs', JSON.stringify(favoritos));
        
        // Refrescar la vista actual sin perder el buscador
        const q = document.getElementById('buscador').value.toLowerCase();
        if (q) filtrar(); else cargarPagina(paginaActual);
      }

      function descargarInd(id) {
        window.open(`https://docs.google.com/uc?export=download&id=${id}`, '_blank');
      }
    </script>
  </body>
</html>

